{{- if and (eq .include_cicd "yes") (eq .cicd_platform "azure_devops") -}}
# Azure DevOps Pipeline for {{.project_name}}
#
# This pipeline validates and deploys Databricks Asset Bundles:
# - BundleCI: Validates bundle configuration on Pull Requests to {{.default_branch}}
# - StagingBundleCD: Deploys to staging when PRs are merged into {{.default_branch}}
{{- if eq .environment_setup "full" }}
# - ProdBundleCD: Deploys to production when PRs are merged into {{.release_branch}}
{{- end }}
#
# Prerequisites:
# 1. Create a Variable Group named "vg_{{.project_name}}" in Azure DevOps with required secrets
# 2. See docs/CI_CD_SETUP.md for detailed configuration instructions

trigger:
  branches:
    include:
      - {{.default_branch}}
{{- if eq .environment_setup "full" }}
      - {{.release_branch}}
{{- end }}
  paths:
    include:
      - '**'
    exclude:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'

pr:
  branches:
    include:
      - {{.default_branch}}
  paths:
    include:
      - '**'
    exclude:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'


variables:
  - name: workingDirectory
    value: .
  - group: vg_{{.project_name}}

stages:
# =============================================================================
# Stage: BundleCI - Validate bundle on Pull Requests
# =============================================================================
- stage: BundleCI
  displayName: 'Bundle Validation for {{.project_name}}'
  # Trigger on PRs to the default branch only
  condition: |
    and(
      not(eq(variables['Build.Reason'], 'IndividualCI')),
      eq(variables['Build.Reason'], 'PullRequest'),
      or(
        eq(variables['System.PullRequest.TargetBranchName'], '{{.default_branch}}'),
        eq(variables['System.PullRequest.TargetBranch'], 'refs/heads/{{.default_branch}}')
      )
    )

  jobs:
  - job: ValidateAndTest
    displayName: 'Run Tests and Validate Bundle'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - checkout: self
      displayName: 'Checkout repository'
      persistCredentials: true
      clean: true

    - task: UsePythonVersion@0
      displayName: 'Use Python 3.11'
      inputs:
        versionSpec: '3.11'

    # Install dependencies if requirements_dev.txt exists
    - script: |
        if [ -f "requirements_dev.txt" ]; then
          echo "Installing development dependencies..."
          python -m pip install --upgrade pip
          pip install -r requirements_dev.txt
        else
          echo "No requirements_dev.txt found, skipping dependency installation"
        fi
      workingDirectory: $(workingDirectory)
      displayName: 'Install Python dependencies'

    # Run unit tests if tests directory exists
    - script: |
        if [ -d "tests" ] && [ -n "$(find tests -name 'test_*.py' -o -name '*_test.py' 2>/dev/null)" ]; then
          echo "Running unit tests..."
          python -m pytest tests/ -v --junitxml=test-results.xml
        else
          echo "No test files found, skipping unit tests"
        fi
      workingDirectory: $(workingDirectory)
      displayName: 'Run unit tests'
      continueOnError: false

    - task: PublishTestResults@2
      displayName: 'Publish test results'
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/test-results.xml'
        failTaskOnFailedTests: true
        testRunTitle: 'Unit Tests - {{.project_name}}'

    # Install Databricks CLI
    - script: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/v{{template "cli_version" .}}/install.sh | sh
      displayName: 'Install Databricks CLI'

    # Validate bundle for staging
    - script: |
        databricks bundle validate -t stage
      workingDirectory: $(workingDirectory)
      displayName: 'Validate bundle for staging'
      env:
{{- if eq .cloud_provider "azure" }}
{{- if eq .workspace_setup "multi_workspace" }}
        DATABRICKS_HOST: $(STAGING_DATABRICKS_HOST)
{{- end }}
        ARM_TENANT_ID: $(STAGING_AZURE_SP_TENANT_ID)
        ARM_CLIENT_ID: $(STAGING_AZURE_SP_APPLICATION_ID)
        ARM_CLIENT_SECRET: $(STAGING_AZURE_SP_CLIENT_SECRET)
{{- else }}
        DATABRICKS_HOST: $(STAGING_DATABRICKS_HOST)
        DATABRICKS_CLIENT_ID: $(STAGING_DATABRICKS_CLIENT_ID)
        DATABRICKS_CLIENT_SECRET: $(STAGING_DATABRICKS_CLIENT_SECRET)
{{- end }}

{{- if eq .environment_setup "full" }}

  - job: ValidateProd
    displayName: 'Validate Bundle for Production'
    dependsOn: ValidateAndTest
    condition: succeeded()  # Only run if ValidateAndTest succeeded (tests pass + stage validation passes)
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - checkout: self
      displayName: 'Checkout repository'
      persistCredentials: true
      clean: true

    # Install Databricks CLI
    - script: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/v{{template "cli_version" .}}/install.sh | sh
      displayName: 'Install Databricks CLI'

    # Validate bundle for production
    - script: |
        databricks bundle validate -t prod
      workingDirectory: $(workingDirectory)
      displayName: 'Validate bundle for production'
      env:
{{- if eq .cloud_provider "azure" }}
{{- if eq .workspace_setup "multi_workspace" }}
        DATABRICKS_HOST: $(PROD_DATABRICKS_HOST)
{{- end }}
        ARM_TENANT_ID: $(PROD_AZURE_SP_TENANT_ID)
        ARM_CLIENT_ID: $(PROD_AZURE_SP_APPLICATION_ID)
        ARM_CLIENT_SECRET: $(PROD_AZURE_SP_CLIENT_SECRET)
{{- else }}
        DATABRICKS_HOST: $(PROD_DATABRICKS_HOST)
        DATABRICKS_CLIENT_ID: $(PROD_DATABRICKS_CLIENT_ID)
        DATABRICKS_CLIENT_SECRET: $(PROD_DATABRICKS_CLIENT_SECRET)
{{- end }}
{{- end }}

# =============================================================================
# Stage: StagingBundleCD - Deploy to staging on merge to {{.default_branch}}
# =============================================================================
- stage: StagingBundleCD
  displayName: 'Deploy to Staging for {{.project_name}}'
  # Trigger on push/merge to default branch (not on PRs)
  condition: |
    and(
      eq(variables['Build.SourceBranch'], 'refs/heads/{{.default_branch}}'),
      not(eq(variables['Build.Reason'], 'PullRequest'))
    )

  jobs:
  - job: DeployStaging
    displayName: 'Deploy Bundle to Staging'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - checkout: self
      displayName: 'Checkout repository'
      persistCredentials: true
      clean: true

    # Install Databricks CLI
    - script: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/v{{template "cli_version" .}}/install.sh | sh
      displayName: 'Install Databricks CLI'

    # Validate before deploy
    - script: |
        databricks bundle validate -t stage
      workingDirectory: $(workingDirectory)
      displayName: 'Validate bundle for staging'
      env:
{{- if eq .cloud_provider "azure" }}
{{- if eq .workspace_setup "multi_workspace" }}
        DATABRICKS_HOST: $(STAGING_DATABRICKS_HOST)
{{- end }}
        ARM_TENANT_ID: $(STAGING_AZURE_SP_TENANT_ID)
        ARM_CLIENT_ID: $(STAGING_AZURE_SP_APPLICATION_ID)
        ARM_CLIENT_SECRET: $(STAGING_AZURE_SP_CLIENT_SECRET)
{{- else }}
        DATABRICKS_HOST: $(STAGING_DATABRICKS_HOST)
        DATABRICKS_CLIENT_ID: $(STAGING_DATABRICKS_CLIENT_ID)
        DATABRICKS_CLIENT_SECRET: $(STAGING_DATABRICKS_CLIENT_SECRET)
{{- end }}

    # Deploy bundle to staging
    - script: |
        databricks bundle deploy -t stage
      workingDirectory: $(workingDirectory)
      displayName: 'Deploy bundle to staging'
      env:
{{- if eq .cloud_provider "azure" }}
{{- if eq .workspace_setup "multi_workspace" }}
        DATABRICKS_HOST: $(STAGING_DATABRICKS_HOST)
{{- end }}
        ARM_TENANT_ID: $(STAGING_AZURE_SP_TENANT_ID)
        ARM_CLIENT_ID: $(STAGING_AZURE_SP_APPLICATION_ID)
        ARM_CLIENT_SECRET: $(STAGING_AZURE_SP_CLIENT_SECRET)
{{- else }}
        DATABRICKS_HOST: $(STAGING_DATABRICKS_HOST)
        DATABRICKS_CLIENT_ID: $(STAGING_DATABRICKS_CLIENT_ID)
        DATABRICKS_CLIENT_SECRET: $(STAGING_DATABRICKS_CLIENT_SECRET)
{{- end }}

{{- if eq .environment_setup "full" }}

# =============================================================================
# Stage: ProdBundleCD - Deploy to production on merge to {{.release_branch}}
# =============================================================================
- stage: ProdBundleCD
  displayName: 'Deploy to Production for {{.project_name}}'
  # Trigger on push/merge to release branch (not on PRs)
  condition: |
    and(
      eq(variables['Build.SourceBranch'], 'refs/heads/{{.release_branch}}'),
      not(eq(variables['Build.Reason'], 'PullRequest'))
    )

  jobs:
  - job: DeployProd
    displayName: 'Deploy Bundle to Production'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - checkout: self
      displayName: 'Checkout repository'
      persistCredentials: true
      clean: true

    # Install Databricks CLI
    - script: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/v{{template "cli_version" .}}/install.sh | sh
      displayName: 'Install Databricks CLI'

    # Validate before deploy
    - script: |
        databricks bundle validate -t prod
      workingDirectory: $(workingDirectory)
      displayName: 'Validate bundle for production'
      env:
{{- if eq .cloud_provider "azure" }}
{{- if eq .workspace_setup "multi_workspace" }}
        DATABRICKS_HOST: $(PROD_DATABRICKS_HOST)
{{- end }}
        ARM_TENANT_ID: $(PROD_AZURE_SP_TENANT_ID)
        ARM_CLIENT_ID: $(PROD_AZURE_SP_APPLICATION_ID)
        ARM_CLIENT_SECRET: $(PROD_AZURE_SP_CLIENT_SECRET)
{{- else }}
        DATABRICKS_HOST: $(PROD_DATABRICKS_HOST)
        DATABRICKS_CLIENT_ID: $(PROD_DATABRICKS_CLIENT_ID)
        DATABRICKS_CLIENT_SECRET: $(PROD_DATABRICKS_CLIENT_SECRET)
{{- end }}

    # Deploy bundle to production
    - script: |
        databricks bundle deploy -t prod
      workingDirectory: $(workingDirectory)
      displayName: 'Deploy bundle to production'
      env:
{{- if eq .cloud_provider "azure" }}
{{- if eq .workspace_setup "multi_workspace" }}
        DATABRICKS_HOST: $(PROD_DATABRICKS_HOST)
{{- end }}
        ARM_TENANT_ID: $(PROD_AZURE_SP_TENANT_ID)
        ARM_CLIENT_ID: $(PROD_AZURE_SP_APPLICATION_ID)
        ARM_CLIENT_SECRET: $(PROD_AZURE_SP_CLIENT_SECRET)
{{- else }}
        DATABRICKS_HOST: $(PROD_DATABRICKS_HOST)
        DATABRICKS_CLIENT_ID: $(PROD_DATABRICKS_CLIENT_ID)
        DATABRICKS_CLIENT_SECRET: $(PROD_DATABRICKS_CLIENT_SECRET)
{{- end }}
{{- end }}
{{- end }}
