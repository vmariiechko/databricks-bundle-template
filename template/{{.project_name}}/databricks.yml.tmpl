# This is a Databricks asset bundle definition for {{.project_name}}.
# See https://docs.databricks.com/dev-tools/bundles/index.html for documentation.
#
# Generated with: databricks bundle init
# Compute type: {{.compute_type}}
# Environment setup: {{.environment_setup}}
{{- if eq .include_permissions "yes" }}
# Permissions: Enabled (4-group RBAC)
{{- else }}
# Permissions: Disabled (configure manually if needed)
{{- end }}

bundle:
  name: {{.project_name}}
  databricks_cli_version: '>= {{template "cli_version" .}}'

# Experimental features configuration
experimental:
  # Skip adding prefix to Unity Catalog schema names
  # This keeps schema names consistent across environments (bronze, silver, gold)
  # while other resources (jobs, pipelines) still get environment prefixes
  skip_name_prefix_for_schema: true

include:
  - resources/*.yml
  - variables.yml

targets:
  # ------------------------
  # Local Development Target
  # ------------------------
  user:
    mode: development
    default: true
    workspace:
      host: {{workspace_host}}
      root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}
    presets:
      name_prefix: "[user ${workspace.current_user.short_name}] "
      trigger_pause_status: PAUSED
      pipelines_development: true
      tags:
        environment: user

    #### Variables ####
    variables:
      catalog_name: "user_${workspace.current_user.short_name}_{{.uc_catalog_suffix}}"
      default_schema_name: "bronze"
      pipeline_min_workers: 1
      pipeline_max_workers: 1
      photon_enabled: false
      continuous_mode: false
      failure_notification_emails: []
      job_cluster_min_workers: 1
      job_cluster_max_workers: 1
      max_retries: 0  # No retries in dev mode - fail fast

{{- if eq .include_permissions "yes" }}

    #### Resource Overrides ####
    resources:
      schemas:
        # Bronze: Full access for developers in user environment
        bronze_schema:
          name: bronze
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.developers_group}
              privileges:
                - ALL_PRIVILEGES

        # Silver: Full access for developers
        silver_schema:
          name: silver
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.developers_group}
              privileges:
                - ALL_PRIVILEGES

        # Gold: Full access for developers
        gold_schema:
          name: gold
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.developers_group}
              privileges:
                - ALL_PRIVILEGES
{{- end }}

      jobs:
        {{.project_name}}_ingestion:
          # Override schedule - don't run automatically in user env
          schedule:
            quartz_cron_expression: 0 0 2 * * ?  # Same time but paused
            timezone_id: UTC
            pause_status: PAUSED

        {{.project_name}}_pipeline_trigger:
          schedule:
            quartz_cron_expression: 0 0 * * * ?
            timezone_id: UTC
            pause_status: PAUSED

{{- if eq .include_dev_environment "yes" }}

  # -----------------------
  # Development Environment
  # -----------------------
  dev:
    mode: production
    presets:
      name_prefix: "[dev] "
      trigger_pause_status: PAUSED
      tags:
        environment: dev
    workspace:
      host: {{workspace_host}}
      root_path: /Workspace/${bundle.target}/.bundle/${bundle.name}
    git:
      branch: dev
    run_as:
      service_principal_name: ${var.dev_service_principal}

{{- if eq .include_permissions "yes" }}

    #### Permissions ####
    permissions:
    # Developers can run and manage their work
    - level: CAN_MANAGE
      group_name: ${var.developers_group}

    # Service principal or deployment user gets full management
    - level: CAN_MANAGE
      service_principal_name: ${var.dev_service_principal}
{{- end }}

    #### Variables ####
    variables:
      catalog_name: "dev_{{.uc_catalog_suffix}}"
      default_schema_name: "bronze"
      pipeline_min_workers: 1
      pipeline_max_workers: 2
      photon_enabled: true
      continuous_mode: false
      failure_notification_emails:
        - ${workspace.current_user.emails[0].value}
      max_retries: 1  # Limited retries in dev
      retry_interval_millis: 180_000  # 3 minutes
      job_cluster_min_workers: 1
      job_cluster_max_workers: 3

{{- if eq .include_permissions "yes" }}

    #### Resource Overrides ####
    resources:
      schemas:
        # Bronze: Full access for developers and deployment SP
        bronze_schema:
          name: bronze
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.dev_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.developers_group}
              privileges:
                - ALL_PRIVILEGES

        # Silver: Developers full access, Analytics read-only
        silver_schema:
          name: silver
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.dev_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.developers_group}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.analytics_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT

        # Gold: Developers full access, Analytics read-only
        gold_schema:
          name: gold
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.dev_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.developers_group}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.analytics_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT
{{- end }}

      jobs:
        {{.project_name}}_ingestion:
          # 1 hour timeout for dev environment
          timeout_seconds: 3600
          # Active schedule for daily testing
          schedule:
            quartz_cron_expression: 0 0 2 * * ?  # At 02:00 AM daily
            timezone_id: UTC
            pause_status: UNPAUSED

        {{.project_name}}_pipeline_trigger:
          schedule:
            quartz_cron_expression: 0 30 2 * * ?  # At 02:30 AM daily (after ingestion)
            timezone_id: UTC
            pause_status: UNPAUSED
{{- end }}

  # -------------------
  # Staging Environment
  # -------------------
  stage:
    mode: production
    presets:
      name_prefix: "[stage] "
      tags:
        environment: stage
    workspace:
      # MULTI-WORKSPACE: If using a separate workspace for stage, replace the host below
      host: {{workspace_host}}
      root_path: /Workspace/${bundle.target}/.bundle/${bundle.name}
    git:
      branch: {{.default_branch}}
    run_as:
      service_principal_name: ${var.stage_service_principal}

{{- if eq .include_permissions "yes" }}

    #### Permissions ####
    permissions:
    # Limited visibility to developers
    - level: CAN_VIEW
      group_name: ${var.developers_group}

    # QA team can run for testing
    - level: CAN_RUN
      group_name: ${var.qa_team_group}

    # Only deployment service principal can manage
    - level: CAN_MANAGE
      service_principal_name: ${var.stage_service_principal}
{{- end }}

    #### Variables ####
    variables:
      catalog_name: "stage_{{.uc_catalog_suffix}}"
      default_schema_name: "bronze"
      pipeline_min_workers: 2
      pipeline_max_workers: 4
      photon_enabled: true
      continuous_mode: false
      failure_notification_emails:
        - ${workspace.current_user.emails[0].value}
      max_retries: 2  # Production-like retry behavior
      retry_interval_millis: 300_000  # 5 minutes
      job_cluster_min_workers: 2
      job_cluster_max_workers: 5

{{- if eq .include_permissions "yes" }}

    #### Resource Overrides ####
    resources:
      schemas:
        # Bronze: SP full access, Developers and QA read-only
        bronze_schema:
          name: bronze
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.stage_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.developers_group}
              privileges:
                - USE_SCHEMA
                - SELECT
            - principal: ${var.qa_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT

        # Silver: SP full access, Developers, QA, and Analytics read-only
        silver_schema:
          name: silver
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.stage_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.developers_group}
              privileges:
                - USE_SCHEMA
                - SELECT
            - principal: ${var.qa_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT
            - principal: ${var.analytics_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT

        # Gold: SP full access, wider read access for testing
        gold_schema:
          name: gold
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.stage_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.developers_group}
              privileges:
                - USE_SCHEMA
                - SELECT
            - principal: ${var.qa_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT
            - principal: ${var.analytics_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT
{{- end }}

      jobs:
        {{.project_name}}_ingestion:
          # Longer timeout for production-like workloads
          timeout_seconds: 7200  # 2 hours
          # Production-like schedule - multiple runs per day for testing
          schedule:
            quartz_cron_expression: 0 0 4,16 * * ?  # At 04:00 AM and 04:00 PM
            timezone_id: UTC
            pause_status: UNPAUSED

        {{.project_name}}_pipeline_trigger:
          # Higher concurrency for testing load
          max_concurrent_runs: 2
          schedule:
            quartz_cron_expression: 0 30 4,16 * * ?  # 30 min after ingestion
            timezone_id: UTC
            pause_status: UNPAUSED

{{- if eq .environment_setup "full" }}

  # ----------------------
  # Production Environment
  # ----------------------
  prod:
    mode: production
    presets:
      name_prefix: "[prod] "
      tags:
        environment: prod
    workspace:
      # MULTI-WORKSPACE: If using a separate workspace for production, replace the host below:
      host: {{workspace_host}}
      root_path: /Workspace/${bundle.target}/.bundle/${bundle.name}
    git:
      branch: {{.release_branch}}
    run_as:
      service_principal_name: ${var.prod_service_principal}

{{- if eq .include_permissions "yes" }}

    #### Permissions ####
    permissions:
    # Read-only access for monitoring and analytics
    - level: CAN_VIEW
      group_name: ${var.analytics_team_group}

    # Operations team can run jobs for incident response
    - level: CAN_RUN
      group_name: ${var.operations_group}

    # Only service principal can manage resources
    - level: CAN_MANAGE
      service_principal_name: ${var.prod_service_principal}
{{- end }}

    #### Variables ####
    variables:
      catalog_name: "prod_{{.uc_catalog_suffix}}"
      default_schema_name: "bronze"
      pipeline_min_workers: 2
      pipeline_max_workers: 8
      photon_enabled: true
      # continuous_mode: true  # Uncomment for continuous pipelines
      failure_notification_emails:
        - ${workspace.current_user.emails[0].value}
      max_retries: 3  # Maximum retries for production reliability
      retry_interval_millis: 600_000  # 10 minutes between retries
      job_cluster_min_workers: 2
      job_cluster_max_workers: 8

{{- if eq .include_permissions "yes" }}

    #### Resource Overrides ####
    resources:
      schemas:
        # Bronze: SP full access, Operations read-only (incident investigation)
        bronze_schema:
          name: bronze
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.prod_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.operations_group}
              privileges:
                - USE_SCHEMA
                - SELECT

        # Silver: SP full access, Analytics and Operations read-only
        silver_schema:
          name: silver
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.prod_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.analytics_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT
            - principal: ${var.operations_group}
              privileges:
                - USE_SCHEMA
                - SELECT

        # Gold: SP full access, Analytics and Operations read-only
        gold_schema:
          name: gold
          catalog_name: ${var.catalog_name}
          grants:
            - principal: ${var.prod_service_principal}
              privileges:
                - ALL_PRIVILEGES
            - principal: ${var.analytics_team_group}
              privileges:
                - USE_SCHEMA
                - SELECT
            - principal: ${var.operations_group}
              privileges:
                - USE_SCHEMA
                - SELECT
{{- end }}

      jobs:
        {{.project_name}}_ingestion:
          # Extended timeout for production data volumes
          timeout_seconds: 14400  # 4 hours
          # Production schedule - daily at off-peak hours
          schedule:
            quartz_cron_expression: 0 0 1 * * ?  # At 01:00 AM daily
            timezone_id: UTC
            pause_status: UNPAUSED
          # Production-grade email notifications
          email_notifications:
            on_failure: ${var.failure_notification_emails}
            on_start: []
            on_success: []

        {{.project_name}}_pipeline_trigger:
          # Production - one at a time for consistency
          max_concurrent_runs: 1
          schedule:
            quartz_cron_expression: 0 0 6 * * ?  # At 06:00 AM (after ingestion completes)
            timezone_id: UTC
            pause_status: UNPAUSED

      pipelines:
        {{.project_name}}_pipeline:
          # Production schema
          schema: "bronze"
{{- if or (eq .compute_type "classic") (eq .compute_type "both") }}
          # Production clusters would be defined here when not using serverless
          # clusters:
          #   - label: default
          #     autoscale:
          #       min_workers: 3
          #       max_workers: 10
          #     node_type_id: {{template "node_type_id" .}}
{{- end }}
{{- end }}
