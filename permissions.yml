# ============================================================================
# Databricks Asset Bundle - Permissions Configuration
# ============================================================================
# This file defines reusable permission configurations using YAML anchors.
# Reference these in databricks.yml to maintain consistent access control.
#
# Documentation: https://docs.databricks.com/dev-tools/bundles/permissions
# ============================================================================

# ----------------------------------------------------------------------------
# YAML Anchors for Reusable Permission Configurations
# ----------------------------------------------------------------------------

# Development Environment Permissions
development_permissions: &development_permissions
  permissions:
    # All users can view development resources
    - level: CAN_VIEW
      group_name: users

    # Developers can run and manage their work
    - level: CAN_MANAGE_RUN
      group_name: ${var.developers_group}

    # Service principal or deployment user gets full management
    - level: CAN_MANAGE
      service_principal_name: ${var.dev_service_principal}


# Stage Environment Permissions
stage_permissions: &stage_permissions
  permissions:
    # Limited visibility to developers
    - level: CAN_VIEW
      group_name: ${var.developers_group}

    # QA team can run for testing
    - level: CAN_RUN
      group_name: ${var.qa_team_group}

    # Only deployment service principal can manage
    - level: CAN_MANAGE
      service_principal_name: ${var.stage_service_principal}


# Production Environment Permissions
production_permissions: &production_permissions
  permissions:
    # Read-only access for monitoring and analytics
    - level: CAN_VIEW
      group_name: ${var.analytics_team_group}

    # Operations team can run jobs for incident response
    - level: CAN_RUN
      group_name: ${var.operations_group}

    # Only service principal can manage resources
    - level: CAN_MANAGE
      service_principal_name: ${var.prod_service_principal}

# ----------------------------------------------------------------------------
# Resource-Specific Permission Templates
# ----------------------------------------------------------------------------

# Jobs - Standard permissions for data processing jobs
job_standard_permissions: &job_standard_permissions
  permissions:
    - level: CAN_VIEW
      group_name: users

# Pipelines - DLT pipeline permissions
pipeline_standard_permissions: &pipeline_standard_permissions
  permissions:
    - level: CAN_VIEW
      group_name: users

# Experiments - MLflow experiment permissions
experiment_standard_permissions: &experiment_standard_permissions
  permissions:
    - level: CAN_READ
      group_name: users
    # - level: CAN_EDIT
    #   group_name: data_scientists
    # - level: CAN_MANAGE
    #   group_name: ml_engineering_team

# Secret Scopes - Secrets management
secret_scope_permissions: &secret_scope_permissions
  permissions:
    - level: READ
      group_name: users
    # - level: WRITE
    #   group_name: data_engineering_team
    # - level: MANAGE
    #   service_principal_name: ${var.service_principal}

# Unity Catalog Schemas - Schema permissions
schema_permissions: &schema_permissions
  grants:
    - principal: users
      privileges:
        - SELECT
    # - principal: data_engineering_team
    #   privileges:
    #     - SELECT
    #     - MODIFY
    #     - CREATE_TABLE
    # - principal: ${var.service_principal}
    #   privileges:
    #     - ALL_PRIVILEGES

# ----------------------------------------------------------------------------
# Permission Sets by Role (For Reference)
# ----------------------------------------------------------------------------

# These are example role-based permission sets that can be uncommented
# and customized based on your organization's structure.

# data_engineer_permissions: &data_engineer_permissions
#   permissions:
#     - level: CAN_MANAGE_RUN
#       group_name: data_engineers

# data_analyst_permissions: &data_analyst_permissions
#   permissions:
#     - level: CAN_VIEW
#       group_name: data_analysts

# ml_engineer_permissions: &ml_engineer_permissions
#   permissions:
#     - level: CAN_MANAGE
#       group_name: ml_engineers

# admin_permissions: &admin_permissions
#   permissions:
#     - level: CAN_MANAGE
#       group_name: workspace_admins

# service_principal_permissions: &service_principal_permissions
#   permissions:
#     - level: CAN_MANAGE
#       service_principal_name: ${var.service_principal_id}

# ----------------------------------------------------------------------------
# NOTES ON USAGE
# ----------------------------------------------------------------------------
#
# 1. YAML Anchors Usage:
#    Reference these anchors in your databricks.yml using <<: *anchor_name
#    Example:
#      targets:
#        dev:
#          <<: *development_permissions
#
# 2. Combining Permissions:
#    Permissions from different levels are MERGED:
#    - Bundle-level permissions apply to all resources
#    - Target-level permissions override/add to bundle-level
#    - Resource-level permissions override/add to target-level
#
# 3. Permission Principals:
#    Use ONE of these per permission entry:
#    - user_name: email@example.com
#    - group_name: group_name
#    - service_principal_name: <application-id>
#
# 4. Best Practices:
#    ✓ Use target-level permissions for environment-wide access control
#    ✓ Use resource-level permissions only for exceptions
#    ✓ Use service principals for prod/stage with run_as
#    ✓ Keep development environments accessible for collaboration
#    ✓ Document your permission strategy in this file
#
# 5. Variables:
#    Define service principal IDs and group names in variables.yml:
#    - dev_service_principal
#    - stage_service_principal
#    - prod_service_principal
#
# ============================================================================



